<!DOCTYPE html>
<html>
<head>
    <title>Drilling and Lowering Progress</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <div id="drilling-chart"></div>
    <div id="lowering-chart"></div>
    <div id="excavation-pie-chart"></div>
    <div id="pipe-laying-pie-chart"></div>

    <script>
        // Fetch data from the CSV file
        fetch('https://zorawer.github.io/jjmproject/testfetch.csv')
            .then(response => response.text())
            .then(data => {
                // Process the data
                const parsedData = Plotly.d3.csv.parse(data);

                // Group the data by month for drilling
                const drillingData = parsedData.reduce((accumulator, row) => {
                    if (row['Drilling Status'] === 'Completed' && row['T/W Drill Start Date']) {
                        const dateParts = row['T/W Drill Start Date'].split('/');
                        const month = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]).toLocaleString('default', { month: 'long' });
                        if (accumulator.hasOwnProperty(month)) {
                            accumulator[month].completed += parseInt(row['D/N Pipe Laying (m)']) || 0;
                        } else {
                            accumulator[month] = {
                                completed: parseInt(row['D/N Pipe Laying (m)']) || 0,
                                wip: 0
                            };
                        }
                    } else if (row['Drilling Status'] === 'WIP' && row['T/W Drill Start Date']) {
                        const dateParts = row['T/W Drill Start Date'].split('/');
                        const month = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]).toLocaleString('default', { month: 'long' });
                        if (accumulator.hasOwnProperty(month)) {
                            accumulator[month].wip += parseInt(row['D/N Pipe Laying (m)']) || 0;
                        } else {
                            accumulator[month] = {
                                completed: 0,
                                wip: parseInt(row['D/N Pipe Laying (m)']) || 0
                            };
                        }
                    }
                    return accumulator;
                }, {});

                // Group the data by month for lowering
                const loweringData = parsedData.reduce((accumulator, row) => {
                    if (row['T/W Lowering Status'] === 'Completed' && row['T/W Lowering Date']) {
                        const dateParts = row['T/W Lowering Date'].split('/');
                        const month = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]).toLocaleString('default', { month: 'long' });
                        if (accumulator.hasOwnProperty(month)) {
                            accumulator[month].completed += parseInt(row['D/N Pipe Laying (m)']) || 0;
                        } else {
                            accumulator[month] = {
                                completed: parseInt(row['D/N Pipe Laying (m)']) || 0,
                                wip: 0
                            };
                        }
                    } else if (row['T/W Lowering Status'] === 'WIP' && row['T/W Lowering Date']) {
                        const dateParts = row['T/W Lowering Date'].split('/');
                        const month = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]).toLocaleString('default', { month: 'long' });
                        if (accumulator.hasOwnProperty(month)) {
                            accumulator[month].wip += parseInt(row['D/N Pipe Laying (m)']) || 0;
                        } else {
                            accumulator[month] = {
                                completed: 0,
                                wip: parseInt(row['D/N Pipe Laying (m)']) || 0
                            };
                        }
                    }
                    return accumulator;
                }, {});

                // Calculate the sum of D/N Excavation (m)
                const excavationSum = parsedData.reduce((sum, row) => {
                    const excavation = parseInt(row['D/N Excavation (m)']) || 0;
                    return sum + excavation;
                }, 0);

                // Calculate the sum of Distribition System Length
                const distributionSum = parsedData.reduce((sum, row) => {
                    const distribution = parseInt(row['Distribition System Length']) || 0;
                    return sum + distribution;
                }, 0);

                // Create the drilling chart data
                const drillingMonths = Object.keys(drillingData);
                const drillingCounts = drillingMonths.map(month => drillingData[month].completed);
                const drillingWIP = drillingMonths.map(month => drillingData[month].wip);

                // Create the lowering chart data
                const loweringMonths = Object.keys(loweringData);
                const loweringCounts = loweringMonths.map(month => loweringData[month].completed);
                const loweringWIP = loweringMonths.map(month => loweringData[month].wip);

                // Create the excavation pie chart data
                const excavationPieData = [{
                    values: [excavationSum, distributionSum - excavationSum],
                    labels: ['Work Done', 'Scope Remaining'],
                    type: 'pie',
                    marker: {
                        colors: ['#2ca02c', '#d3d3d3']
                    },
                    textinfo: 'label+percent',
                    hoverinfo: 'text',
                    text: [`${excavationSum} m (${((excavationSum / distributionSum) * 100).toFixed(2)}%)`, `${(distributionSum - excavationSum)} m (${(((distributionSum - excavationSum) / distributionSum) * 100).toFixed(2)}%)`]
                }];

                // Create the drilling chart
                const drillingChart = {
                    x: drillingMonths,
                    y: drillingCounts,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Drilling Completion',
                    marker: {
                        color: '#1f77b4'
                    }
                };

                // Create the WIP marker for drilling
                const drillingWIPMarker = {
                    x: drillingMonths,
                    y: drillingWIP,
                    type: 'scatter',
                    mode: 'markers',
                    name: 'Drilling WIP',
                    marker: {
                        symbol: 'circle',
                        size: 10,
                        color: '#FFA500'
                    }
                };

                // Create the lowering chart
                const loweringChart = {
                    x: loweringMonths,
                    y: loweringCounts,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Lowering Completion',
                    marker: {
                        color: '#ff7f0e'
                    }
                };

                // Create the WIP marker for lowering
                const loweringWIPMarker = {
                    x: loweringMonths,
                    y: loweringWIP,
                    type: 'scatter',
                    mode: 'markers',
                    name: 'Lowering WIP',
                    marker: {
                        symbol: 'circle',
                        size: 10,
                        color: '#FFA500'
                    }
                };

                // Calculate the count of D/N Pipe Laying Status
                const pipeLayingStatusData = parsedData.reduce((accumulator, row) => {
                    const status = row['D/N Pipe Laying Status'];
                    if (status === 'Not Started' || status === 'WIP') {
                        if (accumulator.hasOwnProperty(status)) {
                            accumulator[status]++;
                        } else {
                            accumulator[status] = 1;
                        }
                    }
                    return accumulator;
                }, {});

                // Create the pipe laying pie chart data
                const pipeLayingPieData = [{
                    values: Object.values(pipeLayingStatusData),
                    labels: Object.keys(pipeLayingStatusData),
                    type: 'pie',
                    marker: {
                        colors: ['#FFA500', '#d3d3d3']
                    },
                    textinfo: 'label+percent',
                    hoverinfo: 'text',
                    text: Object.entries(pipeLayingStatusData).map(([status, count]) => `${status} (${((count / distributionSum) * 100).toFixed(2)}%)`)
                }];

                // Create the layout for drilling and lowering charts
                const drillingLayout = {
                    title: 'Drilling and Lowering Progress',
                    xaxis: {
                        title: 'Month'
                    },
                    yaxis: {
                        title: 'D/N Pipe Laying (m)',
                        range: [0, Math.max(...drillingCounts, ...drillingWIP, ...loweringCounts, ...loweringWIP)]
                    },
                    legend: {
                        x: 1,
                        xanchor: 'right',
                        y: 1.1,
                        orientation: 'h',
                        traceorder: 'normal',
                        tracegroupgap: 10,
                        itemclick: 'toggle'
                    },
                    shapes: [
                        // Target shape for July
                        {
                            type: 'rect',
                            xref: 'x',
                            yref: 'y',
                            x0: 'July',
                            y0: 0,
                            x1: 'July',
                            y1: 60,
                            fillcolor: 'red',
                            opacity: 0.5,
                            line: {
                                width: 0
                            }
                        }
                    ]
                };

                // Create the excavation pie chart layout
                const excavationPieLayout = {
                    title: 'Percentage of Work Completed vs Scope (D/N Excavation)',
                    showlegend: false
                };

                // Create the pipe laying pie chart layout
                const pipeLayingPieLayout = {
                    title: 'D/N Pipe Laying Status',
                    showlegend: true
                };

                // Plot the charts
                Plotly.newPlot('drilling-chart', [drillingChart, drillingWIPMarker], drillingLayout);
                Plotly.newPlot('lowering-chart', [loweringChart, loweringWIPMarker], drillingLayout);
                Plotly.newPlot('excavation-pie-chart', excavationPieData, excavationPieLayout);
                Plotly.newPlot('pipe-laying-pie-chart', pipeLayingPieData, pipeLayingPieLayout);
            })
            .catch(error => console.error(error));
    </script>
</body>
</html>
