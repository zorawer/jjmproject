<!DOCTYPE html>
<html>
<head>
    <title>Drilling and Lowering Completion</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <div id="completion-chart"></div>

    <script>
        // Fetch data from the CSV file
        fetch('https://zorawer.github.io/jjmproject/testfetch.csv')
            .then(response => response.text())
            .then(data => {
                // Process the data
                const parsedData = Plotly.d3.csv.parse(data);

                // Group the data by month for drilling and lowering completion
                const completionData = parsedData.reduce((accumulator, row) => {
                    const loweringStatus = row['T/W Lowering Status'];
                    const drillingStatus = row['Drilling Status'];
                    const startDate = row['T/W Drill Start Date'];

                    if (drillingStatus === 'Completed' && startDate) {
                        const dateParts = startDate.split('/');
                        const month = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]).toLocaleString('default', { month: 'long' });
                        if (accumulator.hasOwnProperty(month)) {
                            accumulator[month].completed += 1;
                        } else {
                            accumulator[month] = {
                                completed: 1,
                                wip: 0,
                                lowering: 0
                            };
                        }
                    } else if (drillingStatus === 'WIP' && startDate) {
                        const dateParts = startDate.split('/');
                        const month = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]).toLocaleString('default', { month: 'long' });
                        if (accumulator.hasOwnProperty(month)) {
                            accumulator[month].wip += 1;
                        } else {
                            accumulator[month] = {
                                completed: 0,
                                wip: 1,
                                lowering: 0
                            };
                        }
                    }

                    if (loweringStatus === 'Completed' && startDate) {
                        const dateParts = startDate.split('/');
                        const month = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]).toLocaleString('default', { month: 'long' });
                        if (accumulator.hasOwnProperty(month)) {
                            accumulator[month].lowering += 1;
                        } else {
                            accumulator[month] = {
                                completed: 0,
                                wip: 0,
                                lowering: 1
                            };
                        }
                    }

                    return accumulator;
                }, {});

                // Define the order of month names
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

                // Create the completion chart data
                const completionMonths = monthNames.filter(month => completionData.hasOwnProperty(month));
                const completionCounts = completionMonths.map(month => completionData[month].completed);
                const wipCounts = completionMonths.map(month => completionData[month].wip);
                const loweringCounts = completionMonths.map(month => completionData[month].lowering);

                // Create the completion chart
                const completionChart = {
                    x: completionMonths,
                    y: completionCounts,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Drilling Completion',
                    marker: {
                        color: '#1f77b4'
                    }
                };

                // Create the WIP marker
                const wipMarker = {
                    x: completionMonths,
                    y: wipCounts,
                    type: 'scatter',
                    mode: 'markers',
                    name: 'Work in Progress',
                    marker: {
                        symbol: 'circle',
                        size: 10,
                        color: '#FFA500'
                    }
                };

                // Create the lowering marker
                const loweringMarker = {
                    x: completionMonths,
                    y: loweringCounts,
                    type: 'scatter',
                    mode: 'markers',
                    name: 'Lowering Completion',
                    marker: {
                        symbol: 'diamond',
                        size: 10,
                        color: '#FF0000'
                    }
                };

                const completionLayout = {
                    title: 'Drilling and Lowering Completion by Month',
                    xaxis: {
                        title: 'Month'
                    },
                    yaxis: {
                        title: 'Number of Schemes'
                    }
                };

                // Create the completion chart
                Plotly.newPlot('completion-chart', [completionChart, wipMarker, loweringMarker], completionLayout);
            })
            .catch(error => console.error(error));
    </script>
</body>
</html>
