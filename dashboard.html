<!DOCTYPE html>
<html>
<head>
    <title>JJM Drilling and Lowering Completion</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <div id="drilling-chart"></div>
    <div id="lowering-chart"></div>

    <script>
        // Fetch data from the CSV file
        fetch('https://zorawer.github.io/jjmproject/testfetch.csv')
            .then(response => response.text())
            .then(data => {
                // Process the data
                const parsedData = Plotly.d3.csv.parse(data);

                // Group the data by month for drilling completion
                const drillingData = parsedData.reduce((accumulator, row) => {
                    if (row['Drilling Status'] === 'Completed' && row['T/W Drill Start Date']) {
                        const dateParts = row['T/W Drill Start Date'].split('/');
                        const month = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]).toLocaleString('default', { month: 'long' });
                        if (accumulator.hasOwnProperty(month)) {
                            accumulator[month].completed += 1;
                        } else {
                            accumulator[month] = {
                                completed: 1,
                                wip: 0
                            };
                        }
                    } else if (row['Drilling Status'] === 'WIP' && row['T/W Drill Start Date']) {
                        const dateParts = row['T/W Drill Start Date'].split('/');
                        const month = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]).toLocaleString('default', { month: 'long' });
                        if (accumulator.hasOwnProperty(month)) {
                            accumulator[month].wip += 1;
                        } else {
                            accumulator[month] = {
                                completed: 0,
                                wip: 1
                            };
                        }
                    }
                    return accumulator;
                }, {});

                // Group the data by month for lowering completion
                const loweringData = parsedData.reduce((accumulator, row) => {
                    if (row['T/W Lowering Date']) {
                        const dateParts = row['T/W Lowering Date'].split('/');
                        const month = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]).toLocaleString('default', { month: 'long' });
                        if (accumulator.hasOwnProperty(month)) {
                            accumulator[month].completed += 1;
                        } else {
                            accumulator[month] = {
                                completed: 1,
                                wip: 0
                            };
                        }
                    } else if (row['T/W Lowering Status'] === 'WIP' && row['T/W Drill Start Date']) {
                        const dateParts = row['T/W Drill Start Date'].split('/');
                        const month = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]).toLocaleString('default', { month: 'long' });
                        if (accumulator.hasOwnProperty(month)) {
                            accumulator[month].wip += 1;
                        } else {
                            accumulator[month] = {
                                completed: 0,
                                wip: 1
                            };
                        }
                    }
                    return accumulator;
                }, {});

                // Define the order of month names
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

                // Create the drilling chart data
                const drillingMonths = monthNames.filter(month => drillingData.hasOwnProperty(month));
                const drillingCounts = drillingMonths.map(month => drillingData[month].completed);
                const drillingWIP = drillingMonths.map(month => drillingData[month].wip);

                // Create the lowering chart data
                const loweringMonths = monthNames.filter(month => loweringData.hasOwnProperty(month));
                const loweringCounts = loweringMonths.map(month => loweringData[month].completed);
                const loweringWIP = loweringMonths.map(month => loweringData[month].wip);

                // Create the drilling chart
                const drillingChart = {
                    x: drillingMonths,
                    y: drillingCounts,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: `Drilling Completion (${drillingCounts.reduce((total, count) => total + count, 0)})`,
                    marker: {
                        color: '#1f77b4'
                    }
                };

                // Create the WIP marker for drilling
                const drillingWIPMarker = {
                    x: drillingMonths,
                    y: drillingWIP,
                    type: 'scatter',
                    mode: 'markers',
                    name: `Drilling WIP (${drillingWIP.reduce((total, count) => total + count, 0)})`,
                    marker: {
                        symbol: 'circle',
                        size: 10,
                        color: '#FFA500'
                    }
                };

                const drillingAnnotations = drillingMonths.map((month, index) => ({
                    x: month,
                    y: drillingCounts[index],
                    text: drillingCounts[index].toString(),
                    xanchor: 'left',
                    yanchor: 'middle',
                    showarrow: false
                }));

                const drillingTargetAnnotation = {
                     x: 'July',
    y: 60,
    text: 'Target: 60',
    xanchor: 'left',
    yanchor: 'middle',
    showarrow: false,
    font: {
        color: '#FF0000',
        size: 12
    },
    marker: {
        symbol: 'diamond',
        size: 10,
        color: '#FF0000'
    }
};

                const drillingLayout = {
                    title: 'Drilling Completion by Month',
                    xaxis: {
                        title: 'Month'
                    },
                    yaxis: {
                        title: 'Number of Drilling Schemes',
                        range: [0, Math.max(...drillingCounts, ...drillingWIP, 60)]
                    },
                    annotations: drillingAnnotations.concat([drillingTargetAnnotation])
                };

                // Create the lowering chart
                const loweringChart = {
                    x: loweringMonths,
                    y: loweringCounts,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: `Lowering Completion (${loweringCounts.reduce((total, count) => total + count, 0)})`,
                    marker: {
                        color: '#1f77b4'
                    }
                };

                // Create the WIP marker for lowering
                const loweringWIPMarker = {
                    x: loweringMonths,
                    y: loweringWIP,
                    type: 'scatter',
                    mode: 'markers',
                    name: `Lowering WIP (${loweringWIP.reduce((total, count) => total + count, 0)})`,
                    marker: {
                        symbol: 'circle',
                        size: 10,
                        color: '#FFA500'
                    }
                };

                const loweringAnnotations = loweringMonths.map((month, index) => ({
                    x: month,
                    y: loweringCounts[index],
                    text: loweringCounts[index].toString(),
                    xanchor: 'left',
                    yanchor: 'middle',
                    showarrow: false
                }));

             const loweringTargetAnnotation = {
    x: 'July',
    y: 60,
    text: 'Target: 60',
    xanchor: 'left',
    yanchor: 'middle',
    showarrow: false,
    font: {
        color: '#FF0000',
        size: 12
    },
    marker: {
        symbol: 'square',
        size: 10,
        color: '#FF0000'
    }
};
                const loweringLayout = {
                    title: 'Lowering Completion by Month',
                    xaxis: {
                        title: 'Month'
                    },
                    yaxis: {
                        title: 'Number of Lowering Schemes',
                        range: [0, Math.max(...loweringCounts, ...loweringWIP, 60)]
                    },
                    annotations: loweringAnnotations.concat([loweringTargetAnnotation])
                };

                // Create the drilling chart
                Plotly.newPlot('drilling-chart', [drillingChart, drillingWIPMarker], drillingLayout);

                // Create the lowering chart
                Plotly.newPlot('lowering-chart', [loweringChart, loweringWIPMarker], loweringLayout);
            })
            .catch(error => console.error(error));
    </script>

// Filter the data for "Distribution System Length" and "D/N Excavation (m)"
const pieChartData = parsedData.map(row => ({
    distributionSystemLength: row['Distribition System Length'],
    dnExcavation: row['D/N Excavation (m)']
}));

// Count the occurrences of each value
const countDistributionSystemLength = {};
const countDnExcavation = {};

pieChartData.forEach(row => {
    countDistributionSystemLength[row.distributionSystemLength] = (countDistributionSystemLength[row.distributionSystemLength] || 0) + 1;
    countDnExcavation[row.dnExcavation] = (countDnExcavation[row.dnExcavation] || 0) + 1;
});

// Extract the unique values and their counts
const distributionSystemLengthValues = Object.keys(countDistributionSystemLength);
const distributionSystemLengthCounts = Object.values(countDistributionSystemLength);
const dnExcavationValues = Object.keys(countDnExcavation);
const dnExcavationCounts = Object.values(countDnExcavation);

// Create the pie chart data for "Distribution System Length"
const distributionSystemLengthPieData = [{
    labels: distributionSystemLengthValues,
    values: distributionSystemLengthCounts,
    type: 'pie',
    name: 'Distribution System Length',
    textinfo: 'label+percent',
    hoverinfo: 'text',
    text: distributionSystemLengthValues.map((value, index) => `${value}: ${distributionSystemLengthCounts[index]} schemes`)
}];

// Create the pie chart data for "D/N Excavation (m)"
const dnExcavationPieData = [{
    labels: dnExcavationValues,
    values: dnExcavationCounts,
    type: 'pie',
    name: 'D/N Excavation (m)',
    textinfo: 'label+percent',
    hoverinfo: 'text',
    text: dnExcavationValues.map((value, index) => `${value}: ${dnExcavationCounts[index]} schemes`)
}];

// Create the pie chart layout
const pieLayout = {
    title: 'Distribution System Length and D/N Excavation',
    showlegend: true,
    legend: {
        x: 0.5,
        y: 1.1,
        orientation: 'h',
        traceorder: 'normal'
    },
    grid: {
        rows: 1,
        columns: 2
    }
};

// Plot the pie charts
Plotly.newPlot('distribution-system-length-chart', distributionSystemLengthPieData, pieLayout);
Plotly.newPlot('dn-excavation-chart', dnExcavationPieData, pieLayout);


</body>
</html>
