<!DOCTYPE html>
<html>
<head>
    <title>Drilling and Lowering Completion</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        .chart-container {
            display: flex;
            justify-content: space-between;
        }
    </style>
</head>
<body>
    <h1>JJM - HFCL Project Dashboard</h1>

    <div class="chart-container">
        <div id="drilling-chart"></div>
        <div id="lowering-chart"></div>
    </div>
    <div class="chart-container">
        <div id="pipe-laying-pie-chart"></div>
        <div id="wip-pie-chart"></div>
    </div>
    <ul id="wip-scheme-list"></ul>

    <script>
        // Fetch data from the CSV file
        fetch('https://raw.githubusercontent.com/zorawer/jjmproject/main/testfetch.csv')
    .then(response => response.text())
    .then(data => {
        // Process the data
        parsedData = Plotly.d3.csv.parse(data);

                // Group the data by month for drilling completion
                const drillingData = parsedData.reduce((accumulator, row) => {
                    const dateParts = row['T/W Drill Start Date'].split('/');
                    const month = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]).toLocaleString('default', { month: 'long' });
                    if (accumulator.hasOwnProperty(month)) {
                        accumulator[month][row['Drilling Status']] += 1;
                    } else {
                        accumulator[month] = {
                            'Completed': row['Drilling Status'] === 'Completed' ? 1 : 0,
                            'WIP': row['Drilling Status'] === 'WIP' ? 1 : 0
                        };
                    }
                    return accumulator;
                }, {});

                // Sort drilling months in chronological order
                const drillingMonths = Object.keys(drillingData).sort((a, b) => new Date(a) - new Date(b));

                // Create the drilling chart data
                const drillingCompleted = drillingMonths.map(month => drillingData[month]['Completed']);
                const drillingWIP = drillingMonths.map(month => drillingData[month]['WIP']);

                // Create the drilling chart
                const drillingChart = {
                    x: drillingMonths,
                    y: drillingCompleted,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: `Drilling Completion (${drillingCompleted.reduce((total, count) => total + count, 0)})`,
                    marker: {
                        color: '#1f77b4'
                    }
                };

                const drillingWIPMarker = {
                    x: drillingMonths,
                    y: drillingWIP,
                    type: 'scatter',
                    mode: 'markers',
                    name: `Drilling WIP (${drillingWIP.reduce((total, count) => total + count, 0)})`,
                    marker: {
                        symbol: 'circle',
                        size: 10,
                        color: '#FFA500'
                    }
                };

                const drillingLayout = {
                    title: 'Drilling Completion by Month',
                    xaxis: {
                        title: 'Month'
                    },
                    yaxis: {
                        title: 'Number of Drilling Schemes',
                        range: [0, Math.max(...drillingCompleted, ...drillingWIP)]
                    },
                    annotations: []
                };

                Plotly.newPlot('drilling-chart', [drillingChart, drillingWIPMarker], drillingLayout);

                // Group the data by month for lowering completion
                const loweringData = parsedData.reduce((accumulator, row) => {
                    const dateParts = row['T/W Lowering Date'].split('/');
                    const month = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]).toLocaleString('default', { month: 'long' });
                    if (accumulator.hasOwnProperty(month)) {
                        accumulator[month][row['T/W Lowering Status']] += 1;
                    } else {
                        accumulator[month] = {
                            'Completed': row['T/W Lowering Status'] === 'Completed' ? 1 : 0,
                            'WIP': row['T/W Lowering Status'] === 'WIP' ? 1 : 0
                        };
                    }
                    return accumulator;
                }, {});

                // Sort lowering months in chronological order
                const loweringMonths = Object.keys(loweringData).sort((a, b) => new Date(a) - new Date(b));

                // Create the lowering chart data
                const loweringCompleted = loweringMonths.map(month => loweringData[month]['Completed']);
                const loweringWIP = loweringMonths.map(month => loweringData[month]['WIP']);

                // Create the lowering chart
                const loweringChart = {
                    x: loweringMonths,
                    y: loweringCompleted,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: `Lowering Completion (${loweringCompleted.reduce((total, count) => total + count, 0)})`,
                    marker: {
                        color: '#1f77b4'
                    }
                };

                const loweringWIPMarker = {
                    x: loweringMonths,
                    y: loweringWIP,
                    type: 'scatter',
                    mode: 'markers',
                    name: `Lowering WIP (${loweringWIP.reduce((total, count) => total + count, 0)})`,
                    marker: {
                        symbol: 'circle',
                        size: 10,
                        color: '#FFA500'
                    }
                };

                const loweringLayout = {
                    title: 'Lowering Completion by Month',
                    xaxis: {
                        title: 'Month'
                    },
                    yaxis: {
                        title: 'Number of Lowering Schemes',
                        range: [0, Math.max(...loweringCompleted, ...loweringWIP)]
                    },
                    annotations: []
                };

                Plotly.newPlot('lowering-chart', [loweringChart, loweringWIPMarker], loweringLayout);

                // Group the data by D/N Pipe Laying Status
                const pipeLayingStatusData = {
                    labels: ['Not Started', 'WIP'],
                    values: [464, 30],
                    type: 'pie',
                    textposition: 'inside',
                    hoverinfo: 'label+value',
                    textinfo: 'label+percent',
                    marker: {
                        colors: ['#808080', '#FFA500']
                    }
                };

                const pipeLayingStatusLayout = {
                    title: 'D/N Pipe Laying Status',
                    showlegend: true,
                    legend: {
                        x: 0.5,
                        y: -0.1,
                        bgcolor: 'rgba(255, 255, 255, 0.7)',
                        bordercolor: '#000',
                        borderwidth: 1,
                        orientation: 'h',
                        traceorder: 'normal',
                        font: {
                            family: 'Arial, sans-serif',
                            size: 12,
                            color: '#000'
                        }
                    }
                };

                Plotly.newPlot('pipe-laying-pie-chart', [pipeLayingStatusData], pipeLayingStatusLayout);

                // Filter the data for WIP schemes in D/N pipe laying
                const wipData = parsedData.filter(row => row['D/N Pipe Laying Status'] === 'WIP');

                // Calculate the total scope for D/N pipe laying
                const totalScope = wipData.reduce((sum, row) => sum + parseInt(row['Distribition System Length']), 0);

                // Calculate the total work done for WIP schemes in D/N pipe laying
                const workDone = wipData.reduce((sum, row) => sum + parseInt(row['D/N Excavation (m)']), 0);

                // Create the pie chart for WIP schemes in D/N pipe laying
                const wipPieChart = {
                    labels: ['Scope', 'Work Done'],
                    values: [totalScope, workDone],
                    type: 'pie',
                    textposition: 'inside',
                    hoverinfo: 'label+value',
                    textinfo: 'label+percent',
                    marker: {
                        colors: ['#808080', '#FFA500']
                    }
                };

                const wipPieLayout = {
                    title: 'WIP Schemes for D/N Pipe Laying',
                    showlegend: true,
                    legend: {
                        x: 0.5,
                        y: -0.1,
                        bgcolor: 'rgba(255, 255, 255, 0.7)',
                        bordercolor: '#000',
                        borderwidth: 1,
                        orientation: 'h',
                        traceorder: 'normal',
                        font: {
                            family: 'Arial, sans-serif',
                            size: 12,
                            color: '#000'
                        }
                    }
                };

                // Create the WIP pie chart
                Plotly.newPlot('wip-pie-chart', [wipPieChart], wipPieLayout);

                // Attach click event handler to WIP pie chart
                const wipPieChartElement = document.getElementById('wip-pie-chart');
                wipPieChartElement.on('plotly_click', event => {
                    const label = event.points[0].label;
                    if (label === 'WIP') {
                        const wipSchemes = parsedData.filter(row => row['D/N Pipe Laying Status'] === 'WIP');
                        wipSchemes.forEach(row => {
                            const schemeID = row['Scheme ID'];
                            const schemeName = row['Scheme Name'];
                            const listItem = document.createElement('li');
                            listItem.innerHTML = `<a href="#" onclick="openSchemeDetails('${schemeID}')">${schemeID} - ${schemeName}</a>`;
                            document.getElementById('wip-scheme-list').appendChild(listItem);
                        });
                    }
                });

         // Function to open new tab with scheme details

  function openSchemeDetails(id) {
    if (parsedData) {
        const scheme = parsedData.find(row => row['Scheme ID'] === id);
        if (scheme) {
            const schemeDetails = `Scheme ID: ${scheme['Scheme ID']}\nScheme Name: ${scheme['Scheme Name']}\nDistrict: ${scheme['District']}\nBlock: ${scheme['Block']}\nT/W Vendor: ${scheme['T/W Vendor']}`;
            const schemeDetailsWindow = window.open();
            schemeDetailsWindow.document.write(`<pre>${schemeDetails}</pre>`);
            schemeDetailsWindow.document.close();
    }
}
            })
            .catch(error => console.error(error));
    </script>
</body>
</html>
